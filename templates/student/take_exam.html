{% extends 'base.html' %}

{% block title %}Take Quiz{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between mb-2">
    <h4>{{ quiz.title }}</h4>
    <div class="alert alert-info">
      Time Remaining: <span id="timer">--:--:--</span>
    </div>
  </div>

  <div class="mb-3">
    <p><strong>Course:</strong> {{ quiz.course.name }}</p>
    <p><strong>Subject:</strong> {{ quiz.subject.name }}</p>
    <p><strong>Duration:</strong> 
      {{ quiz.duration // 60 }} hour{{ 's' if quiz.duration // 60 != 1 else '' }} 
      {{ quiz.duration % 60 }} minute{{ 's' if quiz.duration % 60 != 1 else '' }}
    </p>
  </div>

  <form method="POST" action="{{ url_for('submit_exam', quiz_id=quiz.id) }}">
    <div class="card shadow p-3 mb-4">
      <h5>Question {{ current_question_index + 1 }} of {{ total }}</h5>
      <p><strong>{{ question.question_text }}</strong></p>

      {% if question.image %}
        <img src="{{ url_for('static', filename='question_images/' ~ question.image) }}" class="img-fluid mb-2">
      {% endif %}

      {% for opt in ['a', 'b', 'c', 'd'] %}
        {% set option_value = question['option_' + opt] %}
        {% if option_value %}
          <div class="form-check">
            <input class="form-check-input" type="radio" name="question_{{ question.id }}" value="{{ opt }}" required>
            <label class="form-check-label">{{ option_value }}</label>
          </div>
        {% endif %}
      {% endfor %}

      {% if question.extra_content %}
        <div class="mt-2">{{ question.extra_content | safe }}</div>
      {% endif %}
    </div>

    <div class="d-flex justify-content-between mt-3">
      {% if current_question_index > 0 %}
        <a href="{{ url_for('take_exam', quiz_id=quiz.id, question_index=current_question_index - 1) }}" class="btn btn-primary">Previous</a>
      {% endif %}
      {% if current_question_index < total - 1 %}
        <a href="{{ url_for('take_exam', quiz_id=quiz.id, question_index=current_question_index + 1) }}" class="btn btn-primary">Next</a>
      {% else %}
        <button type="submit" class="btn btn-success" id="submitBtn">Submit Quiz</button>
      {% endif %}
    </div>
  </form>
</div>

<script>
  let totalSeconds = {{ quiz.duration * 60 }};
  let isSubmitted = {{ is_submitted | tojson }};  // Flag to check if the quiz is already submitted

  function formatTime(seconds) {
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  function updateTimer() {
    const timerElement = document.getElementById("timer");
    timerElement.innerText = formatTime(totalSeconds);

    if (totalSeconds <= 0) {
      clearInterval(timerInterval);
      alert("⏰ Time's up! Submitting your quiz...");
      document.querySelector("form").submit();
    }

    totalSeconds--;
  }

  const timerInterval = setInterval(updateTimer, 1000);

  // Disable the 'Start Exam' button if the quiz is already submitted
  if (isSubmitted) {
    document.getElementById("submitBtn").disabled = true;
    alert("You have already completed this quiz.");
  }
</script>
{% endblock %}